<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.adflow.pms.domain.mapper.UserMapper">

	<resultMap id="UserResult" type="kr.co.adflow.pms.domain.User">
		<result property="userId" column="user_id" />
		<result property="password" column="password" />
		<result property="userName" column="user_name" />
		<result property="role" column="role" />
		<result property="ipFilters" column="ip_filters" />
		<result property="status" column="status" />
		<result property="msgCntLimit" column="message_count_limit" />
		<result property="issueTime" column="issue_time" />
		<result property="issueId" column="issue_id" />
	</resultMap>

	<insert id="insertUser" parameterType="kr.co.adflow.pms.domain.User">
		INSERT INTO pms.user
		(user_id
		,role
		,password
		,user_name
		,ip_filters
		,status
		,message_count_limit
		,issue_time
		,issue_id
		)
		values(
		#{userId}
		,#{role}
		,#{password}
		,#{userName}
		,#{ipFilters}
		,#{status}
		,#{msgCntLimit}
		,now()
		,#{issueId}
		)
	</insert>

	<select id="select" parameterType="String" resultMap="UserResult">
		SELECT
		user_id
		, role
		, user_name
		, ip_filters
		, status
		,message_count_limit
		, issue_time
		, issue_id
		FROM pms.user a
		WHERE
		a.user_id = #{userId}
	</select>

	<select id="listAll" parameterType="String" resultMap="UserResult">
		SELECT
		user_id
		, role
		, user_name
		, ip_filters
		, status
		,message_count_limit
		, issue_time
		, issue_id
		FROM pms.user
	</select>

	<resultMap id="AuthResult" type="kr.co.adflow.pms.domain.User">
		<result property="userId" column="user_id" />
		<result property="role" column="role" />
	</resultMap>

	<select id="selectAuth" parameterType="kr.co.adflow.pms.domain.User"
		resultMap="AuthResult">
		SELECT user_id, role
		FROM pms.user a
		WHERE a.user_id = #{userId}
		AND a.password = #{password}
	</select>

	<update id="updateUserStatus" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		status = #{status}
		, issue_time = now()
		, issue_id = #{issueId}
		WHERE
		user_id = #{userId}
	</update>

	<update id="updateUser" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET role =
		#{role}
		,user_name = #{userName}
		,ip_filters = #{ipFilters}
		,status =
		#{status}
		,message_count_limit = #{msgCntLimit}
		,issue_time = now()
		,issue_id = #{issueId}
		WHERE user_id = #{userId}
	</update>

	<delete id="deleteUser" parameterType="String">
		DELETE FROM pms.user
		WHERE user_id = #{userId}
	</delete>

	<insert id="logUserHistory" parameterType="kr.co.adflow.pms.domain.User">
		INSERT INTO pms.user_h
		(user_id
		,role
		,password
		,user_name
		,ip_filters
		,status
		,message_count_limit
		,issue_time
		,issue_id
		,action
		)
		values(
		#{userId}
		,#{role}
		,#{password}
		,#{userName}
		,#{ipFilters}
		,#{status}
		,#{msgCntLimit}
		,now()
		,#{issueId}
		,#{action}
		)
	</insert>
	
	<select id="getMsgCntLimit" parameterType="String" resultType="int">
		SELECT a.message_count_limit
		FROM pms.user a
		WHERE
		a.user_id = #{userId}
	</select>
	
	<update id="updateMsgCntLimit" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET message_count_limit = #{msgCntLimit}
		,issue_time = now()
		,issue_id = #{issueId}
		WHERE user_id = #{userId}
	</update>
	
	<update id="discountMsgCntLimit" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET message_count_limit = message_count_limit <![CDATA[-]]> #{msgCntLimit}
		,issue_time = now()
		,issue_id = #{userId}
		WHERE user_id = #{userId}
	</update>
	
	<update id="updatePassword" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET password = #{password}
		,issue_time = now()
		,issue_id = #{issueId}
		WHERE user_id = #{userId}
	</update>
</mapper>	