<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.adflow.pms.domain.mapper.UserMapper">

	<resultMap id="UserResult" type="kr.co.adflow.pms.domain.User">
		<result property="userId" column="user_id" />
		<result property="password" column="password" />
		<result property="userName" column="user_name" />
		<result property="status" column="status" />
		<result property="issueTime" column="issue_time" />
		<result property="issueId" column="issue_id" />
		<result property="groupCode" column="group_code" />
		<result property="serverId" column="server_id" />
		<result property="action" column="action" />
		<result property="deviceId" column="device_id" />
		<result property="token" column="token" />

	</resultMap>

	<resultMap id="UserInfo" type="kr.co.adflow.pms.domain.UserInfo">
		<result property="userName" column="user_name" />
		<result property="deviceId" column="device_id" />
		<result property="tokenId" column="token" />

	</resultMap>




	<insert id="insertUser" parameterType="kr.co.adflow.pms.domain.User">
		INSERT INTO pms.user
		(user_id
		,password
		,user_name
		,group_code
		,status
		,issue_time
		,issue_id
		,server_id
		)
		values(
		#{userId}
		,#{password}
		,#{userName}
		,#{groupCode}
		,#{status}
		,now()
		,#{issueId}
		,#{serverId}
		)
	</insert>

	<select id="selectUserInfo" parameterType="String" resultMap="UserInfo">
		SELECT
		a.user_id,
		a.user_name,
		b.token_id
		as token,
		b.device_id as
		device_id
		FROM
		pms.user
		a,
		pms.token b
		WHERE
		a.user_id =
		b.user_id
		AND
		a.user_id = #{userId}
	</select>

	<select id="selectDeleteUser" parameterType="String" resultMap="UserResult">
		SELECT
		a.user_id,
		a.user_name,
		b.device_id as device_id
		FROM
		pms.user a,
		pms.device b
		WHERE
		a.user_id=b.user_id
		AND
		a.user_id = #{userId}
	</select>
	<select id="selectUpdateUser" parameterType="String" resultMap="UserResult">
		SELECT
		user_id,
		user_name
		FROM
		pms.user
		WHERE
		user_id = #{userId}
	</select>




	<select id="selectUserid" parameterType="String" resultType="String">
		SELECT
		user_id
		FROM pms.user
		WHERE
		user_id = #{userId}
	</select>

	<select id="listAll" parameterType="String" resultMap="UserResult">
		SELECT
		a.user_id
		, a.role
		, a.user_name
		, a.ip_filters
		, a.status
		,
		a.default_expiry
		, a.default_qos
		, a.issue_time
		, a.issue_id
		, b.token_id
		as application_token
		FROM pms.user a, pms.token b
		WHERE
		a.user_id =
		b.user_id
		AND b.token_type = 'A'




	</select>

	<resultMap id="AuthResult" type="kr.co.adflow.pms.domain.User">
		<result property="userId" column="user_id" />
		<result property="role" column="role" />
		<result property="ufmi" column="ufmi" />
		<result property="groupTopics" column="group_topics" />
		<result property="userName" column="user_name" />
	</resultMap>

	<select id="selectAuth" parameterType="kr.co.adflow.pms.domain.User"
		resultMap="AuthResult">
		SELECT user_id, role, user_name
		FROM
		pms.user a
		WHERE a.user_id
		= #{userId}
		AND a.password = #{password}
		AND
		a.status = 0
	</select>

	<select id="selectUser" parameterType="String" resultType="String">
		SELECT user_id
		FROM pms.user a
		WHERE a.user_id = #{userId}
	</select>

	<update id="updateUserStatus" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		status = #{status}
		, issue_time = now()
		, issue_id = #{issueId}
		WHERE
		user_id = #{userId}
	</update>

	<update id="updateUser" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		user_name = #{userName}
		,status =
		#{status}
		,issue_time = now()
		,issue_id
		= #{issueId}
		WHERE user_id = #{userId}
	</update>

	<delete id="deleteUser" parameterType="String">
		DELETE FROM pms.user
		WHERE
		user_id = #{userId}
	</delete>

	<insert id="logUserHistory" parameterType="kr.co.adflow.pms.domain.User">
		INSERT INTO pms.user_h
		(action
		,user_id
		,password
		,user_name
		,group_code
		,status
		,issue_time
		,issue_id
		,server_id
		

		)
		values(
		#{action}
		,#{userId}
		,#{password}
		,#{userName}
		,#{groupCode}
		,#{status}
		,now()
		,#{issueId}
		,#{serverId}

		)
	</insert>

	<select id="getMsgCntLimit" parameterType="String" resultType="int">
		SELECT a.message_count_limit
		FROM pms.user a
		WHERE
		a.user_id = #{userId}
	</select>

	<update id="updateMsgCntLimit" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		message_count_limit = #{msgCntLimit}
		,issue_time = now()
		,issue_id =
		#{issueId}
		WHERE user_id = #{userId}
	</update>

	<update id="discountMsgCntLimit" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET message_count_limit = message_count_limit <![CDATA[-]]>
		#{msgCntLimit}
		,issue_time = now()
		,issue_id = #{userId}
		WHERE user_id =
		#{userId}
	</update>

	<update id="updatePassword" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		password = #{password}
		,issue_time = now()
		,issue_id = #{issueId}
		WHERE
		user_id = #{userId}
	</update>

	<select id="selectUfmi" parameterType="String" resultType="String">
		SELECT ufmi
		FROM pms.user
		WHERE
		user_id = #{userId}
	</select>

	<select id="selectRole" parameterType="String" resultType="String">
		SELECT role
		FROM pms.user
		WHERE
		user_id = #{userId}
	</select>

	<update id="updateUserName" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		user_name = #{userName}
		,issue_time = now()
		,issue_id = #{issueId}
		WHERE
		user_id = #{userId}
	</update>

	<update id="updateSvcUser" parameterType="kr.co.adflow.pms.domain.User">
		UPDATE pms.user
		SET
		user_name = #{userName}
		,callback_url = #{callbackUrl}
		,callback_method
		= 'POST'
		,issue_time = now()
		,issue_id = #{issueId}
		WHERE user_id =
		#{userId}
	</update>

	<select id="selectCallbackUrl" parameterType="Map" resultType="String">
		SELECT a.callback_url
		FROM pms.user a, pms.message${keyMon} b
		WHERE
		a.user_id = b.issue_id
		AND b.msg_id = #{msgId}
	</select>

</mapper>	