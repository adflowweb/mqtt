<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.adflow.push.mapper.MessageMapper">
	<select id="get" parameterType="int"
		resultType="kr.co.adflow.push.domain.Message">
		SELECT * FROM message a, content b WHERE a.id = b.id
		and
		a.id = #{id}
	</select>

	<resultMap id="MessageResult" type="kr.co.adflow.push.domain.Message">
		<result property="id" column="id" />
		<result property="sender" column="sender" />
		<result property="receiver" column="receiver" />
		<result property="issue" column="issue" />
		<result property="issueSms" column="issueSms" />
		<result property="qos" column="qos" />
		<result property="retained" column="retained" />
		<result property="sms" column="sms" />
		<result property="sender" column="sender" />
		<result property="timeOut" column="timeOut" />
	</resultMap>

	<select id="getUndeliveredMsg" resultMap="MessageResult">
		select * from message
		where
		issue is null
		<!-- and reservation is not null -->
	</select>

	<!-- <select id="getID" resultType="java.lang.Integer" parameterType="kr.co.adflow.push.domain.Message"> 
		SELECT id FROM message WHERE sender= #{sender} and receiver= #{receiver} 
		and insertDate = #{insertDate} // order by id desc limit 1 </select> -->


	<insert id="postMsg" parameterType="kr.co.adflow.push.domain.Message">
		INSERT INTO
		message (sender, receiver, sms, timeOut, qos, retained,
		reservation) values(
		#{sender}, #{receiver}, #{sms},
		#{timeOut},
		#{qos},
		#{retained}, #{reservation}
		)
		<selectKey keyProperty="id" resultType="Integer" order="AFTER">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
	</insert>

	<update id="putMsg" parameterType="kr.co.adflow.push.domain.Message">
		UPDATE message set
		sender =
		#{sender}, receiver = #{receiver}, sms = #{sms},
		timeOut = #{timeOut},
		qos = #{qos},
		retained = #{retained}, reservation = #{reservation}
		where id = #{id}
	</update>

	<update id="putIssue" parameterType="kr.co.adflow.push.domain.Message">
		UPDATE message set
		issue =
		#{issue} where id = #{id}
	</update>

	<insert id="putContent" parameterType="kr.co.adflow.push.domain.Message">
		UPDATE content set content
		= #{content} where id = #{id}
	</insert>

	<insert id="postContent" parameterType="kr.co.adflow.push.domain.Message">
		INSERT INTO
		content
		values(
		#{id}, #{content}
		)
	</insert>

	<insert id="postAck" parameterType="kr.co.adflow.push.domain.Acknowledge">
		INSERT INTO
		ack
		values(
		#{id},
		#{userID}, #{deviceID}
		)
	</insert>

	<delete id="deleteMsg" parameterType="java.lang.Integer">
		DELETE from
		message
		WHERE
		id=#{id}
	</delete>
</mapper>	